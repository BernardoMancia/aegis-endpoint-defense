<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEGIS EDR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: monospace; }
        .cyber-card { background: #1e293b; border: 1px solid #334155; }
        .status-online { color: #22c55e; text-shadow: 0 0 5px #22c55e; }
        .status-offline { color: #ef4444; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #334155; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<nav class="bg-slate-900 border-b border-slate-700 p-3 flex justify-between items-center">
    <div class="flex items-center gap-2">
        <i class="fas fa-shield-halved text-sky-400"></i>
        <h1 class="text-lg font-bold text-sky-400">AEGIS HQ</h1>
    </div>
    <div class="flex gap-4 items-center">
        <button onclick="updateDetails()" class="text-green-400 border border-green-800 px-3 py-1 rounded text-xs bg-green-900/30 hover:text-white">
            <i class="fas fa-sync-alt"></i> REFRESH
        </button>
        <a href="/logout" class="text-red-400"><i class="fas fa-power-off"></i></a>
    </div>
</nav>

<div class="flex flex-1 overflow-hidden">
    <aside class="w-64 bg-slate-900 border-r border-slate-700 overflow-y-auto p-3">
        <div id="agentList" class="space-y-2">
            {% for agent in agents %}
            <div onclick="selectAgent({{ agent.id }})" class="cyber-card p-3 rounded cursor-pointer hover:bg-slate-800 {{ 'border-l-4 border-green-500' if agent.status=='online' else '' }}">
                <div class="flex justify-between">
                    <span class="font-bold text-sky-300 text-xs truncate">{{ agent.hostname }}</span>
                    <i class="fas fa-{{ 'android' if agent.device_type=='android' else 'desktop' }}"></i>
                </div>
                <div class="text-[10px] text-slate-500">{{ agent.ip_address }}</div>
            </div>
            {% endfor %}
        </div>
    </aside>

    <main class="flex-1 p-4 flex gap-4 overflow-hidden relative" id="mainPanel">
        <div id="welcomeScreen" class="absolute inset-0 flex items-center justify-center text-slate-600">
            <div><i class="fas fa-radar text-6xl mb-2"></i><br>Selecione um alvo.</div>
        </div>

        <div id="activePanel" class="hidden flex gap-4 w-full h-full">
            <div class="w-1/3 flex flex-col gap-4">
                <div class="cyber-card p-3 rounded text-xs">
                    <div class="flex justify-between border-b border-slate-700 pb-1 mb-2">
                        <span class="text-sky-400 font-bold">INFO</span>
                        <div>
                            <button onclick="renameAlias()" class="hover:text-white mr-2" title="Apelido"><i class="fas fa-tag"></i></button>
                            <button onclick="renameSystem()" class="hover:text-red-400" title="Hostname Real (Reboot)"><i class="fas fa-server"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <span class="text-slate-500">Host:</span> <span id="valHost" class="text-right truncate"></span>
                        <span class="text-slate-500">OS:</span> <span id="valOS" class="text-right truncate"></span>
                        <span class="text-slate-500">IP:</span> <span id="valIP" class="text-right text-white"></span>
                        <span class="text-slate-500">Bat:</span> <span id="valBat" class="text-right"></span>
                    </div>
                </div>

                <div class="cyber-card p-3 rounded">
                    <h3 class="text-red-400 font-bold text-xs mb-2">AÇÕES</h3>
                    <div id="actionButtons" class="grid grid-cols-2 gap-2"></div>
                </div>

                <div class="cyber-card p-3 rounded flex-1 flex flex-col">
                    <h3 class="text-purple-400 font-bold text-xs mb-2">VISUAL</h3>
                    <div id="screenContainer" class="flex-1 bg-black rounded flex items-center justify-center overflow-hidden">
                        <img id="screenImg" class="max-w-full max-h-full cursor-pointer" onclick="window.open(this.src)">
                    </div>
                </div>
            </div>

            <div class="w-1/3 flex flex-col gap-4">
                <div class="cyber-card p-3 rounded flex-1 flex flex-col overflow-hidden">
                    <h3 class="text-green-400 font-bold text-xs mb-2">TERMINAL</h3>
                    <div id="logBox" class="flex-1 bg-black p-2 rounded overflow-y-auto text-[10px] font-mono mb-2"></div>
                    <div class="flex gap-1">
                        <input id="shellCmd" class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white" placeholder="Comando..." onkeypress="if(event.key==='Enter') sendShell()">
                        <button onclick="sendShell()" class="bg-slate-700 text-white px-3 rounded text-xs">></button>
                    </div>
                </div>
                <div class="cyber-card p-3 rounded h-1/3 flex flex-col">
                    <h3 class="text-orange-400 font-bold text-xs mb-2">SOFTWARES</h3>
                    <div id="softBox" class="flex-1 overflow-y-auto pr-1 text-[10px] text-slate-400"></div>
                </div>
            </div>

            <div class="w-1/3 flex flex-col gap-4">
                <div class="cyber-card p-3 rounded flex-1 flex flex-col">
                    <h3 class="text-pink-400 font-bold text-xs mb-2">CHAT</h3>
                    <div id="chatBox" class="flex-1 bg-slate-800 p-2 rounded overflow-y-auto mb-2 text-xs"></div>
                    <div class="flex gap-1">
                        <input id="chatMsg" class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') sendChat()">
                        <button onclick="sendChat()" class="bg-pink-700 text-white px-3 rounded text-xs"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
                <div class="cyber-card p-3 rounded h-1/3 flex flex-col">
                    <h3 class="text-emerald-400 font-bold text-xs mb-2">IA</h3>
                    <div id="aiBox" class="flex-1 overflow-y-auto text-[10px] text-emerald-200 mb-2"></div>
                    <div class="flex gap-1">
                        <input id="aiQuestion" class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white" placeholder="Pergunte à IA..." onkeypress="if(event.key==='Enter') askAI()">
                        <button onclick="askAI()" class="bg-emerald-700 px-3 rounded text-white text-xs">?</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
let currentId = null;
let pollInterval = null;
let lastType = null; // Controle para recriar botões se mudar de dispositivo

function selectAgent(id) {
    currentId = id;
    lastType = null; // Força reset dos botões
    document.getElementById('welcomeScreen').classList.add('hidden');
    document.getElementById('activePanel').classList.remove('hidden');
    
    // Limpa UI para não mostrar dados do anterior
    document.getElementById('logBox').innerHTML = '';
    document.getElementById('chatBox').innerHTML = '';
    document.getElementById('softBox').innerHTML = 'Carregando...';
    
    updateDetails(); 
    if(pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(updateDetails, 2000); 
}

async function updateDetails() {
    if(!currentId) return;
    try {
        const res = await fetch(`/get_agent_details/${currentId}`);
        if(!res.ok) return;
        const data = await res.json();
        
        // 1. Info
        document.getElementById('valHost').innerText = data.original_hostname;
        document.getElementById('valOS').innerText = data.os;
        document.getElementById('valIP').innerText = data.public_ip;
        const batElem = document.getElementById('valBat');
        batElem.innerText = data.battery + '%';
        
        // 2. Botões Dinâmicos (Só recria se mudar o tipo)
        const isMobile = data.type === 'android';
        if (lastType !== data.type) {
            const btnsPC = `
                <button onclick="cmd('screenshot')" class="bg-blue-900 text-blue-200 p-2 rounded text-xs border border-blue-700 hover:bg-blue-800">Print</button>
                <button onclick="cmd('beep')" class="bg-orange-900 text-orange-200 p-2 rounded text-xs border border-orange-700 hover:bg-orange-800">Alarme</button>
                <button onclick="cmd('shutdown')" class="bg-red-900 text-red-200 p-2 rounded text-xs border border-red-700 hover:bg-red-800">Desligar</button>
                <button onclick="cmd('analyze_full')" class="bg-emerald-900 text-emerald-200 p-2 rounded text-xs border border-emerald-700 hover:bg-emerald-800">Scan</button>
            `;
            const btnsMob = `
                <button onclick="cmd('vibrate')" class="bg-purple-900/40 text-purple-300 p-2 rounded text-xs border border-purple-800">Vibrar</button>
                <button onclick="cmd('flash_toggle')" class="bg-yellow-900/40 text-yellow-300 p-2 rounded text-xs border border-yellow-800">Flash</button>
                <button onclick="cmd('analyze_full')" class="col-span-2 bg-emerald-900 text-emerald-200 p-2 rounded text-xs border border-emerald-700 hover:bg-emerald-800">Scan</button>
            `;
            document.getElementById('actionButtons').innerHTML = isMobile ? btnsMob : btnsPC;
            lastType = data.type;
        }

        // 3. Print (Força recarregar imagem com timestamp)
        if(data.screenshot) {
            // Verifica se mudou ou adiciona timestamp para evitar cache
            const img = document.getElementById('screenImg');
            // Como é base64 data:image..., a string inteira muda se a imagem mudar.
            // Se fosse URL, precisaria do ?t=...
            if(img.src !== data.screenshot) img.src = data.screenshot;
        }

        // 4. Logs e Chat
        const logBox = document.getElementById('logBox');
        const prevLogScroll = logBox.scrollTop;
        const isLogBottom = (logBox.scrollHeight - logBox.clientHeight) <= (prevLogScroll + 50);
        
        logBox.innerHTML = data.logs.map(l => {
            let color = l.type === 'SHELL_RESULT' ? 'text-green-400' : (l.type==='SECURITY'?'text-red-400':'text-sky-300');
            return `<div class="mb-1"><span class="text-slate-600">[${l.time}]</span> <span class="${color}">${l.type}:</span> <pre class="inline text-slate-300 whitespace-pre-wrap">${l.msg}</pre></div>`
        }).join('');
        if(isLogBottom) logBox.scrollTop = logBox.scrollHeight;

        const chatBox = document.getElementById('chatBox');
        const prevChatScroll = chatBox.scrollTop;
        const isChatBottom = (chatBox.scrollHeight - chatBox.clientHeight) <= (prevChatScroll + 50);
        
        chatBox.innerHTML = data.chat.map(c => `
            <div class="mb-2 ${c.sender === 'admin' ? 'text-right' : 'text-left'}">
                <div class="${c.sender === 'admin' ? 'bg-sky-900 text-sky-100' : 'bg-green-900 text-green-100'} px-2 py-1 rounded inline-block">
                    ${c.msg}
                </div>
            </div>
        `).join('');
        if(isChatBottom) chatBox.scrollTop = chatBox.scrollHeight;

        // 5. Softwares
        const softBox = document.getElementById('softBox');
        // Só atualiza se o tamanho da lista mudar para não pesar a DOM
        if (softBox.childElementCount !== data.software.length && data.software.length > 0) {
            softBox.innerHTML = data.software.map(s => `<div class="border-b border-slate-800 py-1 truncate hover:text-white" title="${s}">${s}</div>`).join('');
        } else if (data.software.length === 0) {
            softBox.innerHTML = '<div class="text-center text-xs mt-4 text-slate-600">Vazio</div>';
        }

        document.getElementById('aiBox').innerText = data.ai;

    } catch(e) { console.log(e); }
}

async function cmd(c, val=null) {
    const f = new FormData(); f.append('agent_id', currentId); f.append('command', c);
    if(val) f.append('shell_cmd', val);
    await fetch('/control/command', {method:'POST', body:f});
}

function sendShell() {
    const v = document.getElementById('shellCmd').value;
    if(v) { cmd('shell', v); document.getElementById('shellCmd').value = ''; }
}

function sendChat() {
    const v = document.getElementById('chatMsg').value;
    if(v) { 
        const f = new FormData(); f.append('agent_id', currentId); f.append('command', 'chat_send'); f.append('message', v);
        fetch('/control/command', {method:'POST', body:f});
        document.getElementById('chatMsg').value = '';
        setTimeout(updateDetails, 300); 
    }
}

function askAI() {
    const v = document.getElementById('aiQuestion').value;
    if(v) {
        const f = new FormData(); f.append('agent_id', currentId); f.append('command', 'ask_ai'); f.append('question', v);
        fetch('/control/command', {method:'POST', body:f});
        document.getElementById('aiQuestion').value = '';
        document.getElementById('aiBox').innerText = "Processando...";
    }
}

function renameAlias() {
    const n = prompt("Novo apelido (Visual):");
    if(n) {
        const f = new FormData(); f.append('agent_id', currentId); f.append('command', 'rename'); f.append('new_name', n);
        fetch('/control/command', {method:'POST', body:f});
        location.reload();
    }
}

function renameSystem() {
    const n = prompt("Novo HOSTNAME do Sistema (Vai reiniciar o PC):");
    if(n) {
        const f = new FormData(); f.append('agent_id', currentId); f.append('command', 'rename_system'); f.append('new_host', n);
        fetch('/control/command', {method:'POST', body:f});
    }
}
</script>
</body>
</html>